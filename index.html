<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>7-11 Delivery - จัดส่งตามตำแหน่ง</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta property="og:title" content="Leaflet and Google Form GPS Data Collection" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://aogdp.github.io/gpsform/" />
  <meta property="og:image" content="https://raw.githubusercontent.com/aogdp/gpsform/gh-pages/img/gpsform.png" />
  <meta property="og:description" content="ใช้สำหรับให้ลูกค้าระบุตำแหน่งในการจัดส่งสินค้า" />
  <!--Bootstrap for form-->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  <!--leaflet-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js"></script>
  
  <!--leaflet new version-->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css"
    integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
    crossorigin=""/>  

  <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"
    integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
    crossorigin=""></script>

  <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.66.2/dist/L.Control.Locate.min.js" charset="utf-8"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.66.2/dist/L.Control.Locate.min.css" />

  <!--Tabletop and GeoJson-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tabletop.js/1.4.3/tabletop.min.js"></script>
  <script src="js/geojson.js"></script>
  <!--Fonts-->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">
  <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,900' rel='stylesheet' type='text/css'>

  <script   src="https://code.jquery.com/jquery-2.2.3.min.js"   integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo="   crossorigin="anonymous"></script>
  <style>
    *{font-family: 'Source Sans Pro', sans-serif;}
    .map {height:70%}
    #map {position:relative;height:900px;}
    .leaflet-popup-content {font-size: medium;}
    .form-group{width:254px;margin-bottom:0;}
    .form-control{resize:none;}
    .text-muted{font-size:smaller;}
    hr {margin: 10px 0;}
    .hideDiv{display:none;}  
  </style>
</head>

<body>
  <div class="container text-center">
    <h3>กรุณาระบุตำแหน่งที่จะให้จัดส่ง</h3>
  </div>
  <div class="map">
    <div id="map"></div>
  </div>
  <div id="footer" data-tracking-area="footer" style="display:none;">
  
  <script type="text/javascript">
  var hashParams = window.location.hash.substr(1).split('&'); // substr(1) to remove the `#`
  //alert(window.location.hash.substr(1));
  var globalHash = {}
  for (var i = 0; i < hashParams.length; i++) {
    var p = hashParams[i].split('=');
    globalHash[p[0]] = decodeURIComponent(p[1]);
  }
  //window.onload = function(){
    //document.getElementById("descrip").value = globalHash.orderno;
  //}
    
  function yesnoCheck() {
      if (document.getElementById('option4').checked) {
          document.getElementById('ifYes').style.display = 'block';
          if(globalHash.ridername){
            document.getElementById("ridername").defaultValue = globalHash.ridername;
          }
      }
      else document.getElementById('ifYes').style.display = 'none';
  }
  
  </script>
  
  <script>
    var map = L.map('map'); //Initialize the map
    var registerId = '1FAIpQLSdi01MLi99QnUmg8RFGfrO22U1f5Bz03FpkVS8gNy2ZPtjGlw';
    var formLat = '617766669';
    var formLng = '328531020';
    var formText = '445527557';
    var formOrderNo = '508187306';
    var formMethod = '1994150821';
    var formRiderName = '1640105652';
    var gsheet = '1pkXqeRyOfe5ldUaxcN8K2TYioATgtIFG9OA6-aL7RzE';
    var registerForm = {
    	'tel'		: ['entry.1469577993',globalHash['entry.549659197']],
	'line'		: ['entry.1519341869',globalHash['entry.1561723974']],
	'email'		: ['entry.972632578',globalHash['entry.999662534']],
	'address'	: ['entry.1102805265',globalHash['entry.1152803505']],
	'selected_store': ['entry.1877097538',globalHash['entry.690413346']],
	'payment'	: ['entry.1152568087',globalHash['entry.543841120']],
	'sex'		: ['entry.1828721874',globalHash['entry.1828721874']],
	'day'		: ['entry.748332598',globalHash['entry.748332598']],
	'month'		: ['entry.1726768213',globalHash['entry.1726768213']],
	'year'		: ['entry.879579647',globalHash['entry.879579647']],
	'allmember'	: ['entry.467769508',globalHash['entry.1250407467']],
	'allmemberOTH'	: ['entry.467769508.other_option_response',globalHash['entry.1250407467.other_option_response']],
	'latitude'	: ['entry.2139030407',globalHash['entry.2139030407']],
	'longitude'	: ['entry.1986078140',globalHash['entry.1986078140']],
    };
	  
    //Add a basemap
    var OpenStreetMap_Mapnik = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    	maxZoom: 18,
    	attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    var inLayer = 0;
    var currentLocation = 0;
    // Delivery Form
    var orderForm = "https://docs.google.com/forms/d/e/1FAIpQLSc28osp_tKOb4nwf6JM4aBiGdtr3PI28ckZqTOX7Kij9G57UQ/viewform?usp=pp_url";
    var source = {
    	'selected_store' : ['entry.690413346',globalHash['entry.690413346']],
	'line'		 : ['entry.1561723974',globalHash['entry.1561723974']],
	'tel'		 : ['entry.549659197',globalHash['entry.549659197']],
	'email'		 : ['entry.999662534',globalHash['entry.999662534']],
	'time'		 : ['entry.959736102',globalHash['entry.959736102']],
	'payment'	 : ['entry.543841120',globalHash['entry.543841120']],
	'address'	 : ['entry.1152803505',globalHash['entry.1152803505']],
	'allmember'	 : ['entry.1250407467',globalHash['entry.1250407467']],
	'allmemberOTH'	 : ['entry.1250407467.other_option_response',globalHash['entry.1250407467.other_option_response']],
	'method'	 : ['entry.1940904798',"รับที่ร้าน 7-11"],
    };
	  
    function popUpFeature(feature, layer){
      if (feature.properties.fill == "") {
        var popupText = "พื้นที่ไม่รองรับการจัดส่ง";
        layer.bindPopup(popupText);
      }
    }
    

    //set up the feature iteration
    var onEachFeature = function(feature, layer) {
        layer.on({
            click: function(e) {
                    collectData(e);
                  }
        });
    }
    
    $.getJSON("geojson_ww_thai_sri.json",function(data){
      // add GeoJSON layer to the map once the file is loaded
      var datalayer = L.geoJson(data ,{
        style: function(feature) {
            return {
                fillColor: feature.properties['fill'],
                fillOpacity: feature.properties['fill-opacity'],
                color: feature.properties['stroke'],
                width: feature.properties['stroke-width'],
                opacity: feature.properties['opacity']
            };
        },
        onEachFeature: onEachFeature
      }).addTo(map);
    });

    var sevenIcon = L.icon({
		iconUrl: 'img/7-11icon.png',
		shadowUrl: 'img/7-11shadow.png',
		iconSize:     [38, 95], // size of the icon
		shadowSize:   [50, 64], // size of the shadow
		iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
		shadowAnchor: [4, 62],  // the same for the shadow
		popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
    });
	  
	var stores = {
		'10747 วงแหวนบางขุนเทียน' : [13.626958630991819, 100.44395327568054],
		'04875 อาคารไทยศรีซูริค' : [13.72048952519465, 100.50171732902527],
		'10254 บางกอกซิตี้ - สาทร' : [13.721776722876555, 100.53122162818909],
		'05410 สาทรสแควร์' : [13.72256884101737, 100.52918314933777],
	};
	var markerObj = {};  
	for (var key in stores) {
		var link = orderForm;
		for (var value in source) {
			if (source[value][1] == undefined) {
				continue;
			}
			if (value == 'selected_store') {
				link += "&"+ source[value][0] + "=" + key;
			}
			else {
				link += "&"+ source[value][0] + "=" + source[value][1];
			}
		}

		var formcc = '<center><b>' + key + '</b><br><button onclick="window.location.href = \'' + link + '\';">รับที่ร้านนี้</button></center>';
    		
		markerObj[key] = L.marker(stores[key], {icon: sevenIcon}).addTo(map).bindPopup(formcc);
  	}
	
	if (source['selected_store'][1] != undefined) {
		if (source['selected_store'][1] in stores) {
			map.setView(stores[source['selected_store'][1]], 18);
			markerObj[source['selected_store'][1]].openPopup();
		}
	}
	if (source['address'][1] == undefined) {
		source['address'][1] = ""
	}

    //Add Location Options - override the plugin default popup and circle
    var locOptions = {
      drawCircle: false,
      showPopup: false,
      follow:true,
    };
    //Add Location
    var loc = L.control.locate(locOptions).addTo(map);
    //Endable Location at page load and do things once the location is found
    //loc.start();
    var marker, circle, lat, lng; //create variables used throughout the map
   
    var popup = L.popup();
    
    function getData(e) {
      //console.log(e);
      lat = e.latlng.lat;
      lng = e.latlng.lng;
      if (inLayer == 0) {
	      popup
		.setLatLng(e.latlng)
		.setContent("<b>พื้นที่นี้ยังไม่รองรับการจัดส่ง</b><br>(" + e.latlng.toString() + ")")
		.openOn(map);
      }
      inLayer = 0;
    }
    
    function collectData(e) {
      //console.log(e);
      lat = e.latlng.lat;
      lng = e.latlng.lng;
      inLayer = 1;

      var form = '<div id="formdiv"><form role="form" id="projectform"><div class="form-group"><div class="form-group"><label for="description" class="requiredField">รายละเอียดที่อยู่ในการจัดส่ง</label><textarea class="form-control" rows="3" id="descrip" placeholder="กรุณาระบุรายละเอียดเช่น บ้านเลขที่, อาคาร, ชั้น, แผนก, อื่นๆ เพื่อให้ง่ายต่อการจัดส่ง">' + source['address'][1] + '</textarea></div><input type="checkbox" name="record" value="yes"> บันทีกที่อยู่นี้ไว้ใช้ครั้งถัดไป<br><em class="text-muted">กดปุ่มด้านล่างเพื่อจัดส่ง</em><div id="formHelp"></div><hr /><center><button type="submit" id="submit" class="btn btn-default btn-sm">จัดส่งตามที่อยู่นี้</button></center></form></div>';

      if (e.accuracy) {
        var radius = (e.accuracy / 2) * 3.28084;
        circle = L.circle(e.latlng, radius).addTo(map);
      }
      marker = L.marker(e.latlng).addTo(map)
      .bindPopup(form, {maxWidth:400});

      //if you try and open the popup right away the location may not be ready, eventhough it's firing after locationfound
      setTimeout(function() {
        marker.openPopup();
        loc.stop();
      }, 100);

      marker.on('popupopen', function() {
        $('#projectform').submit(function(event) {
            	event.preventDefault();
            	var descrip = $('#descrip').val();
		var record = $( "input[type=checkbox][name=record]:checked" ).val();
		
	    	var link = orderForm;
		for (var value in source) {
			if (source[value][1] == undefined) {
				continue;
			}
			if (value == 'method') {
				link += "&"+ source[value][0] + "=จัดส่งตามที่อยู่";
			}
			else if (value == 'address') {
				link += "&"+ source[value][0] + "=" + descrip;
			}
			else {
				link += "&"+ source[value][0] + "=" + source[value][1];
			}
		}
		if (descrip) {
			if (record == "yes") {
				//record to register file
				var submitRegisterLink = 'https://docs.google.com/forms/d/e/' + registerId + '/formResponse?submit=Submit';

				for (var value in registerForm) {
					if (registerForm[value][1] == undefined) {
						continue;
					}
					if (value == 'latitude') {
						submitRegisterLink += "&" + registerForm[value][0] + "=" + lat;
					}
					else if (value == 'longitude'){
						submitRegisterLink += "&" + registerForm[value][0] + "=" + lng;
					}
					else if (value == 'address') {
						submitRegisterLink += "&" + registerForm[value][0] + "=" + descrip;
					}
					else {
						submitRegisterLink += "&" + registerForm[value][0] + "=" + registerForm[value][1];
					}
				}
				submitRegisterLink += '"';
				$('#formdiv').html('<iframe src="' + submitRegisterLink + ' seamless scrolling="no" style="overflow:hidden;height:375px;border:lightgray solid thin;"></iframe>');
			}
			location.href = link;
		}
		else {
               		$('#formHelp').html('<span style="color:red;">กรุณาระบุรายละเอียดที่อยู่</span>')
            	}

          });
      });

      if (marker) {
        marker.on('popupclose', function(e) {
          map.removeLayer(marker);
          if (map.hasLayer(circle)) {
            map.removeLayer(circle);
          }
        });
      }
    }
/*
    map.on('locationfound', function(e) {
      collectData(e);
    });
*/

    map.on('locationfound', function(e) {
      getData(e);
    });
	  
  setTimeout(function() {
    if(currentLocation == 0){
      return false;
    }else if(lat) {
      return false;
    }else{
      console.log('no loc');
      loc.stop();
      map.setView([39,-82], 10);
      alert('No location found')
    }
    }, 6000);
    /*
    map.on('click', function(e) {
      collectData(e);
    });
    */

    map.on('click', function(e) {
      getData(e);
    });


/*    map.on('stopfollowing', function() {
      if (marker) { 
        marker.closePopup();
      }
    });*/
    //Add form response points
    //Add an empty geojson layer for the google sheet points and create the popup
    var gps = new L.geoJson(null, {
      onEachFeature: function(feature, layer) {
        layer.bindPopup(feature.properties.Description)
      }
    });
    //Grab the google sheet data using tabletop - published to the web not just shared - and use geojson.min.js to convert into proper geojson format
    var tabletop = Tabletop.init( {
      key: gsheet,
      simpleSheet: true,
      parseNumbers: true,
      callback: function(data, tabletop) {
        var gpsData = GeoJSON.parse(data, {Point: ['Latitude', 'Longitude']});
        //add that data to the geojson layer created earlier
        gps.addData(gpsData);
        gps.addTo(map);
      },
    });

  </script>
<script>
</body>
</html>
